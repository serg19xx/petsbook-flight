name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, bcmath
        tools: composer:v2

    - name: ğŸ“¦ Install dependencies locally
      run: composer install --no-dev --optimize-autoloader

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ğŸŒ Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 64.188.10.53 >> ~/.ssh/known_hosts

    - name: ğŸ“¤ Deploy to server
      env:
        SERVER_IP: 64.188.10.53
        SERVER_USER: root
        PROJECT_PATH: /var/www/petsbook-flight
      run: |

        set -e
        set -x

        # 1. ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ (Ñ‚Ğ¾Ñ‡Ğ½Ğ°Ñ ĞºĞ¾Ğ¿Ğ¸Ñ, ĞºÑ€Ğ¾Ğ¼Ğµ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ñ…)
        echo "ğŸš€ Deploying to $SERVER_IP..."

        # 1. ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ (Ñ‚Ğ¾Ñ‡Ğ½Ğ°Ñ ĞºĞ¾Ğ¿Ğ¸Ñ, ĞºÑ€Ğ¾Ğ¼Ğµ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ñ…)
        rsync -avz --delete \
          --exclude='.git' --exclude='node_modules' --exclude='vendor' \
          --exclude='logs/*' --exclude='.env*' \
          ./ $SERVER_USER@$SERVER_IP:$PROJECT_PATH/

        # 2. ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ .env.production
        ssh $SERVER_USER@$SERVER_IP "rm -f $PROJECT_PATH/.env.production"
        ssh $SERVER_USER@$SERVER_IP "echo '${{ secrets.ENV_PROD_PRODUCTION }}' > $PROJECT_PATH/.env.production && chmod 600 $PROJECT_PATH/.env.production"

        # 3. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ¸Ğ· .env.production
        ssh $SERVER_USER@$SERVER_IP "
          cd $PROJECT_PATH
          docker compose -f docker-compose.prod.yml down
          docker compose -f docker-compose.prod.yml up -d --build
        "

        # 4. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
        ssh $SERVER_USER@$SERVER_IP "docker exec petsbook-php-prod composer install --no-dev --optimize-autoloader"

        # 5. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ, ĞµÑĞ»Ğ¸ ĞµÑ‘ Ğ½ĞµÑ‚, Ğ¸ Ñ‡Ğ¸Ğ½Ğ¸Ğ¼ Ğ¿Ñ€Ğ°Ğ²Ğ°
        ssh $SERVER_USER@$SERVER_IP "mkdir -p $PROJECT_PATH/public/profile-images/email-tmpl"
        ssh $SERVER_USER@$SERVER_IP "docker exec petsbook-php-prod chown -R www-data:www-data /var/www/html/public/profile-images"
        ssh $SERVER_USER@$SERVER_IP "docker exec petsbook-php-prod chmod -R 755 /var/www/html/public/profile-images"

        # 6. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²
        ssh $SERVER_USER@$SERVER_IP "cd $PROJECT_PATH && docker compose -f docker-compose.prod.yml ps"

    - name: ğŸ§ª Test API
      run: |
        sleep 10
        if curl -f -s -k "https://64.188.10.53/api/test" > /dev/null; then
          echo "âœ… API is working!"
        else
          echo "âŒ API test failed"
          ssh root@64.188.10.53 "docker exec petsbook-php-prod tail -20 /var/www/html/logs/php_errors.log" || true
          exit 1
        fi

    - name: ğŸ‰ Deployment Status
      run: |
        echo "ğŸ‰ Deployed at: $(date)"
        echo "ğŸŒ API URL: https://64.188.10.53"