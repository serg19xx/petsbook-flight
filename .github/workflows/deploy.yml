name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, bcmath
        tools: composer:v2

    - name: ğŸ“¦ Install dependencies locally
      run: composer install --no-dev --optimize-autoloader

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ğŸŒ Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 64.188.10.53 >> ~/.ssh/known_hosts

    - name: ğŸ“¤ Deploy to server
      env:
        SERVER_IP: 64.188.10.53
        SERVER_USER: root
        PROJECT_PATH: /var/www/petsbook-flight
      run: |
        set -e
        set -x

        echo "ğŸš€ Deploying to $SERVER_IP..."

        # 1. ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
        rsync -avz --delete \
          --exclude='.git' --exclude='node_modules' --exclude='vendor' \
          --exclude='logs/*' --exclude='.env*' \
          ./ $SERVER_USER@$SERVER_IP:$PROJECT_PATH/ || (echo "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ rsync"; exit 1)

        # 2. ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ .env.production
        ssh $SERVER_USER@$SERVER_IP "rm -f $PROJECT_PATH/.env.production" || (echo "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ .env.production"; exit 1)
        ssh $SERVER_USER@$SERVER_IP "echo '${{ secrets.ENV_PROD_PRODUCTION }}' > $PROJECT_PATH/.env.production && chmod 644 $PROJECT_PATH/.env.production" || (echo "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ .env.production"; exit 1)

        # 3. ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
        ssh $SERVER_USER@$SERVER_IP "cd $PROJECT_PATH && docker compose -f docker-compose.prod.yml down" || (echo "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ docker compose down"; exit 1)

        # 4. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
        ssh $SERVER_USER@$SERVER_IP "cd $PROJECT_PATH && docker compose -f docker-compose.prod.yml up -d --build" || (
          echo "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ docker compose up"
          ssh $SERVER_USER@$SERVER_IP "docker logs petsbook-php-prod || true"
          ssh $SERVER_USER@$SERVER_IP "docker logs petsbook-nginx-prod || true"
          exit 1
        )

        # 5. ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ² (Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ²ÑÑ‘ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾)
        ssh $SERVER_USER@$SERVER_IP "docker logs petsbook-php-prod || true"
        ssh $SERVER_USER@$SERVER_IP "docker logs petsbook-nginx-prod || true"

    - name: Restore SSL certificates
      run: |
        mkdir -p ssl
        if [ -n "${{ secrets.SSL_FULLCHAIN }}" ] && [ -n "${{ secrets.SSL_PRIVKEY }}" ]; then
          echo "${{ secrets.SSL_FULLCHAIN }}" | base64 -d > ssl/fullchain.pem
          echo "${{ secrets.SSL_PRIVKEY }}" | base64 -d > ssl/privkey.pem
          chmod 644 ssl/fullchain.pem
          chmod 600 ssl/privkey.pem
          echo "SSL certificates restored from secrets"
        else
          echo "Creating self-signed SSL certificates..."
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout ssl/privkey.pem \
            -out ssl/fullchain.pem \
            -subj "/C=CA/ST=Ontario/L=Toronto/O=PetsBook/CN=api.petsbook.ca"
          chmod 644 ssl/fullchain.pem
          chmod 600 ssl/privkey.pem
          echo "Self-signed SSL certificates created"
        fi

    - name: ğŸ‰ Deployment Status
      run: |
        echo "ğŸ‰ Deployed at: $(date)"
        echo "ğŸŒ API URL: https://64.188.10.53"