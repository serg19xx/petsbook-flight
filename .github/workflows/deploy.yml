name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, bcmath
        tools: composer:v2

    - name: ğŸ“¦ Install dependencies locally
      run: composer install --no-dev --optimize-autoloader

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ğŸŒ Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 64.188.10.53 >> ~/.ssh/known_hosts

    - name: ğŸ“¤ Deploy to server
      env:
        SERVER_IP: 64.188.10.53
        SERVER_USER: root
        PROJECT_PATH: /var/www/petsbook-flight
      run: |
        echo "ğŸš€ Deploying to $SERVER_IP..."

        # Copy files
        echo "ğŸ“¤ Syncing project files to server..."
        rsync -avz --delete \
          --exclude='.git' --exclude='node_modules' --exclude='vendor' \
          --exclude='logs/*' --exclude='.env*' \
          ./ $SERVER_USER@$SERVER_IP:$PROJECT_PATH/

        # Upload .env.production from GitHub Secret
        echo "ğŸ” Uploading .env.production..."
        ssh $SERVER_USER@$SERVER_IP "echo '${{ secrets.ENV_PROD_PRODUCTION }}' > $PROJECT_PATH/.env.production && chmod 600 $PROJECT_PATH/.env.production"

        # Install dependencies on server
        echo "ğŸ“¦ Installing dependencies on server..."
        ssh $SERVER_USER@$SERVER_IP "cd $PROJECT_PATH && composer install --no-dev --optimize-autoloader"

        # Docker compose up
        echo "ğŸ³ Restarting Docker containers..."
        ssh $SERVER_USER@$SERVER_IP "cd $PROJECT_PATH && docker compose -f docker-compose.prod.yml down && docker compose -f docker-compose.prod.yml up -d --build"

        # Wait for startup
        sleep 15

        # Container status
        ssh $SERVER_USER@$SERVER_IP "cd $PROJECT_PATH && docker compose -f docker-compose.prod.yml ps"

    - name: ğŸ§ª Test API
      run: |
        sleep 10
        if curl -f -s -k "https://64.188.10.53/api/test" > /dev/null; then
          echo "âœ… API is working!"
        else
          echo "âŒ API test failed"
          ssh root@64.188.10.53 "docker exec petsbook-php-prod tail -10 /var/www/html/logs/php_errors.log" || true
          exit 1
        fi

    - name: ğŸ‰ Deployment Status
      run: |
        echo "ğŸ‰ Deployed at: $(date)"
        echo "ğŸŒ API URL: https://64.188.10.53"