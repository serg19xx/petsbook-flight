name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, bcmath
        tools: composer:v2
        
    - name: ğŸ“¦ Install dependencies
      run: composer install --no-dev --optimize-autoloader
      
    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: ğŸŒ Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 64.188.10.53 >> ~/.ssh/known_hosts
        
    - name: ğŸ“¤ Deploy to server
      env:
        SERVER_IP: 64.188.10.53
        SERVER_USER: root
        PROJECT_PATH: /var/www/petsbook-flight
      run: |
        echo "ğŸš€ Deploying to $SERVER_IP..."
        

        
        if [ -z "${{ secrets.JWT_SECRET }}" ]; then
          echo "âŒ JWT_SECRET is missing!"
          exit 1
        fi
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ .env.production Ğ¸Ğ· ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²
        cat > .env.production << 'EOF'
        # Application
        APP_NAME=PetsBook
        APP_ENV=production
        APP_DEBUG=false
        APP_URL=https://64.188.10.53
        
        # Database
        DB_CONNECTION=mysql
        DB_HOST=localhost
        DB_PORT=3306
        DB_NAME=petsbook_new
        DB_USER=petsbook_serg
        DB_PASSWORD=TapinkaPetulka
        DB_ROOT_PASSWORD=your_secure_root_password_here
        
        # JWT
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        
        # Mail
        MAIL_DRIVER=sendgrid_api
        MAIL_SENDER_EMAIL=email@mail.com
        MAIL_SENDER_PHONE=3123423412
        SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
        
        # CORS
        CORS_ALLOWED_ORIGINS=https://site.petsbook.ca,https://64.188.10.53,http://localhost:5173
        
        # Google Translate
        GOOGLE_TRANSLATE_API_KEY=${{ secrets.GOOGLE_TRANSLATE_API_KEY }}
        
        # Logging
        LOG_LEVEL=error
        
        # Security
        SESSION_SECURE_COOKIE=true
        SESSION_SAME_SITE=strict
        EOF
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ“¤ Copying files to server..."
        rsync -avz --exclude='.git' --exclude='node_modules' --exclude='vendor' \
          --exclude='logs/*' --exclude='.env' \
          ./ $SERVER_USER@$SERVER_IP:$PROJECT_PATH/
          
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ .env.production
        echo "ğŸ” Copying .env.production..."
        scp .env.production $SERVER_USER@$SERVER_IP:$PROJECT_PATH/
        
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
        echo "ğŸ“¦ Installing dependencies on server..."
        ssh $SERVER_USER@$SERVER_IP "cd $PROJECT_PATH && composer install --no-dev --optimize-autoloader"
        
        # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
        echo "ğŸ›‘ Stopping old containers..."
        ssh $SERVER_USER@$SERVER_IP "cd $PROJECT_PATH && docker compose -f docker-compose.prod.yml down"
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
        echo "ğŸš€ Starting new containers..."
        ssh $SERVER_USER@$SERVER_IP "cd $PROJECT_PATH && docker compose -f docker-compose.prod.yml up -d --build"
        
        # Ğ–Ğ´Ñ‘Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
        echo "â³ Waiting for containers to start..."
        sleep 15
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
        echo "âœ… Checking container status..."
        ssh $SERVER_USER@$SERVER_IP "cd $PROJECT_PATH && docker compose -f docker-compose.prod.yml ps"
        
    - name: ğŸ§ª Test API
      run: |
        echo "ğŸ§ª Testing API..."
        sleep 10
        if curl -f -s -k "https://64.188.10.53/api/test" > /dev/null; then
          echo "âœ… API is working!"
        else
          echo "âŒ API test failed"
          echo "Checking logs..."
          ssh root@64.188.10.53 "docker exec petsbook-php-prod tail -10 /var/www/html/logs/php_errors.log" || true
          exit 1
        fi
        
    - name: ğŸ“Š Deployment Status
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ API URL: https://64.188.10.53"
        echo "ğŸ“… Deployed at: $(date)"
